# システム設計書テンプレート

## 基本情報

- **プロジェクト名**:
- **設計者**:
- **作成日**:
- **レビュー日**:
- **承認日**:
- **バージョン**:

## 1. システム概要

### 1.1 システム目的

- **目的**:
- **対象ユーザー**:
- **主要機能**:

### 1.2 システム構成概要

```text
[クライアント] ↔ [API Gateway] ↔ [アプリケーション] ↔ [データベース]
```

## 2. アーキテクチャ設計

### 2.1 システムアーキテクチャ

#### 2.1.1 全体構成図

```text
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Frontend  │ ←→ │   Backend   │ ←→ │  Database   │
│   (Next.js) │    │  (NestJS)   │    │(PostgreSQL) │
└─────────────┘    └─────────────┘    └─────────────┘
       ↑                   ↑                   ↑
       │                   │                   │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    CDN      │    │    Cache    │    │   Backup    │
│             │    │   (Redis)   │    │             │
└─────────────┘    └─────────────┘    └─────────────┘
```

#### 2.1.2 レイヤー構成

| レイヤー | 技術 | 責務 |
|----------|------|------|
| プレゼンテーション層 | Next.js | UI/UX、ユーザー操作 |
| アプリケーション層 | NestJS | ビジネスロジック、API |
| データアクセス層 | TypeORM | データ操作 |
| データ層 | PostgreSQL | データ永続化 |

### 2.2 マイクロサービス設計

#### サービス分割

| サービス名 | 責務 | 技術スタック | ポート |
|------------|------|--------------|--------|
| User Service | ユーザー管理 | NestJS, PostgreSQL | 3001 |
| Movie Service | 映画情報管理 | NestJS, PostgreSQL | 3002 |
| Review Service | レビュー管理 | NestJS, PostgreSQL | 3003 |

#### サービス間通信

```text
User Service ←→ Movie Service: REST API
Movie Service ←→ Review Service: gRPC
```

## 3. データ設計

### 3.1 データベース設計

#### 3.1.1 ER図

```text
[User] ──── [Review] ──── [Movie]
  │            │            │
  │            │            │
[Profile]   [Rating]    [Genre]
```

#### 3.1.2 テーブル定義

##### users テーブル

| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| id | UUID | PK | ユーザーID |
| email | VARCHAR(255) | UNIQUE, NOT NULL | メールアドレス |
| password_hash | VARCHAR(255) | NOT NULL | パスワードハッシュ |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

### 3.2 データフロー

```text
Frontend → API Gateway → Service Layer → Repository → Database
```

## 4. セキュリティ設計

### 4.1 認証・認可

| 項目 | 方式 | 実装詳細 |
|------|------|----------|
| 認証 | JWT | Access Token + Refresh Token |
| 認可 | RBAC | Role-Based Access Control |
| セッション管理 | Redis | トークンのブラックリスト管理 |

### 4.2 セキュリティ対策

| 脅威 | 対策 | 実装方法 |
|------|------|----------|
| SQL Injection | パラメータ化クエリ | TypeORM使用 |
| XSS | サニタイゼーション | DOMPurify使用 |
| CSRF | CSRFトークン | csurf middleware |
| 不正アクセス | レート制限 | express-rate-limit |

## 5. パフォーマンス設計

### 5.1 キャッシュ戦略

| データタイプ | キャッシュ方式 | TTL | 無効化タイミング |
|--------------|----------------|-----|------------------|
| ユーザー情報 | Redis | 1時間 | ユーザー更新時 |
| 映画データ | CDN | 24時間 | データ更新時 |
| API レスポンス | Application Cache | 5分 | データ変更時 |

### 5.2 データベース最適化

| 項目 | 対策 | 詳細 |
|------|------|------|
| インデックス | 複合インデックス | 検索条件に基づく |
| コネクションプール | 最大20接続 | アプリケーション層 |
| クエリ最適化 | N+1問題対策 | Eager Loading |

## 6. 監視・ログ設計

### 6.1 ログ設計

| ログレベル | 出力内容 | 出力先 |
|------------|----------|--------|
| ERROR | エラー情報、スタックトレース | ファイル + 外部サービス |
| WARN | 警告情報 | ファイル |
| INFO | アプリケーションイベント | ファイル |
| DEBUG | 詳細な実行情報 | 開発環境のみ |

### 6.2 監視項目

| 項目 | 監視内容 | 閾値 | アラート |
|------|----------|------|--------|
| CPU使用率 | サーバーCPU | 80% | Slack通知 |
| メモリ使用率 | アプリケーション | 85% | Email通知 |
| レスポンス時間 | API応答時間 | 2秒 | ダッシュボード |
| エラー率 | 4xx/5xxエラー | 5% | 即座に通知 |

## 7. デプロイメント設計

### 7.1 環境構成

| 環境 | 目的 | 構成 | URL |
|------|------|------|-----|
| Development | 開発 | Docker Compose | localhost |
| Staging | テスト | Kubernetes | staging.example.com |
| Production | 本番 | Kubernetes | example.com |

### 7.2 CI/CDパイプライン

```text
Code Push → Build → Test → Security Scan → Deploy
```

#### パイプラインステップ

1. **Build**: Docker イメージ作成
2. **Test**: 単体テスト、統合テスト
3. **Security**: 脆弱性スキャン
4. **Deploy**: Blue-Green デプロイメント

## 8. 非機能要件対応

### 8.1 パフォーマンス要件

| 項目 | 要件 | 実装方法 |
|------|------|----------|
| レスポンス時間 | 2秒以内 | キャッシュ、CDN |
| 同時接続数 | 1000ユーザー | ロードバランサー |
| 可用性 | 99.9% | 冗長化構成 |

### 8.2 スケーラビリティ

| 項目 | 対応方法 |
|------|----------|
| 水平スケーリング | Kubernetes HPA |
| データベーススケーリング | Read Replica |
| ファイルストレージ | S3互換ストレージ |

## 9. テスト設計

### 9.1 テスト戦略

| テストタイプ | ツール | カバレッジ目標 |
|--------------|-------|----------------|
| 単体テスト | Jest | 80% |
| 統合テスト | Supertest | 主要API |
| E2Eテスト | Playwright | 主要シナリオ |

### 9.2 テスト環境

```text
Test Database ← Test Application → Mock External APIs
```

## 10. 運用設計

### 10.1 バックアップ戦略

| データタイプ | 頻度 | 保持期間 | 復旧目標 |
|--------------|------|----------|----------|
| データベース | 毎日 | 30日 | RTO: 1時間 |
| ファイル | 毎週 | 90日 | RPO: 24時間 |

### 10.2 災害復旧

| シナリオ | 対応方法 | 復旧時間 |
|----------|----------|----------|
| サーバー障害 | 別AZへフェイルオーバー | 30分 |
| データセンター障害 | DR サイトへ切り替え | 2時間 |

## 11. 技術的負債管理

### 11.1 品質管理

| 項目 | ツール | 基準 |
|------|-------|------|
| コード品質 | SonarQube | Grade A |
| 脆弱性 | Snyk | High以上は即修正 |
| 依存関係 | pnpm audit | 定期更新 |

### 11.2 リファクタリング計画

- 四半期ごとの技術的負債棚卸し
- 優先度付けと計画的な解消
- メトリクス追跡

---

**設計書レビューチェックリスト:**

- [ ] 要件定義書との整合性確認
- [ ] 非機能要件の実現可能性検証
- [ ] セキュリティ要件の網羅性確認
- [ ] 運用・保守の実現可能性確認
- [ ] 技術選定の妥当性検証
