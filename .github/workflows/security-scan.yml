# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ - åŸºæœ¬ãƒ»é«˜é€Ÿã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œæŸ»
name: Security Scan

on:
  push:
    branches: ['main', 'feature/**', 'hotfix/**']
  pull_request:
    branches: ['main']
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 17 * * *'

env:
  NODE_VERSION: '22'

jobs:
  # å¤‰æ›´æ¤œå‡º
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      config: ${{ steps.changes.outputs.config }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            config:
              - '.github/workflows/**'
              - 'package.json'
              - '**/package.json'
              - '**/pnpm-lock.yaml'

  # ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆCodeQLï¼‰
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend == 'true' ||
      needs.detect-changes.outputs.frontend == 'true' ||
      needs.detect-changes.outputs.config == 'true'

    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend == 'true' ||
      needs.detect-changes.outputs.frontend == 'true'

    strategy:
      matrix:
        service:
          - { name: 'user-service', path: 'backend/user-service' }
          - { name: 'movie-service', path: 'backend/movie-service' }
          - { name: 'actor-service', path: 'backend/actor-service' }
          - { name: 'scene-service', path: 'backend/scene-service' }
          - { name: 'review-service', path: 'backend/review-service' }
          - { name: 'frontend', path: 'frontend' }

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Check if service exists
        id: check-service
        run: |
          if [ -f "${{ matrix.service.path }}/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Handle incompatible lockfile and install dependencies
        if: steps.check-service.outputs.exists == 'true'
        run: |
          echo "Attempting to install with frozen lockfile..."
          if ! pnpm install --frozen-lockfile; then
            echo "Frozen lockfile failed, likely due to version incompatibility"
            echo "Regenerating lockfile with current pnpm version $(pnpm --version)..."
            rm -f pnpm-lock.yaml
            pnpm install
            echo "Lockfile regenerated successfully"
          else
            echo "Frozen lockfile installation successful"
          fi

      - name: Run pnpm audit
        if: steps.check-service.outputs.exists == 'true'
        working-directory: ${{ matrix.service.path }}
        run: |
          echo "ğŸ” Running security audit for ${{ matrix.service.name }}"
          pnpm audit --audit-level=high --json > audit-report.json || true

          # é«˜ãƒ»é‡å¤§ãƒ¬ãƒ™ãƒ«ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯
          VULNERABILITIES=$(jq -r '.advisories | length' audit-report.json 2>/dev/null || echo "0")

          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "âš ï¸ Found $VULNERABILITIES high/critical vulnerabilities in ${{ matrix.service.name }}"
            jq -r '.advisories[] | "- \(.title) (Severity: \(.severity))"' audit-report.json
            echo "::warning::${{ matrix.service.name }} has $VULNERABILITIES high/critical vulnerabilities"
          else
            echo "âœ… No high/critical vulnerabilities found in ${{ matrix.service.name }}"
          fi

      - name: Upload audit report
        if: steps.check-service.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: audit-report-${{ matrix.service.name }}
          path: ${{ matrix.service.path }}/audit-report.json
          retention-days: 30

  # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend == 'true' ||
      needs.detect-changes.outputs.frontend == 'true' ||
      needs.detect-changes.outputs.config == 'true'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: HEAD
          extra_args: --debug --only-verified

  # ESLint ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
  eslint-security:
    name: ESLint Security Rules
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend == 'true' ||
      needs.detect-changes.outputs.frontend == 'true'

    strategy:
      matrix:
        service:
          - { name: 'user-service', path: 'backend/user-service' }
          - { name: 'movie-service', path: 'backend/movie-service' }
          - { name: 'actor-service', path: 'backend/actor-service' }
          - { name: 'scene-service', path: 'backend/scene-service' }
          - { name: 'review-service', path: 'backend/review-service' }
          - { name: 'frontend', path: 'frontend' }

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Check if service exists
        id: check-service
        run: |
          if [ -f "${{ matrix.service.path }}/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Handle incompatible lockfile and install dependencies
        if: steps.check-service.outputs.exists == 'true'
        run: |
          echo "Attempting to install with frozen lockfile..."
          if ! pnpm install --frozen-lockfile; then
            echo "Frozen lockfile failed, likely due to version incompatibility"
            echo "Regenerating lockfile with current pnpm version $(pnpm --version)..."
            rm -f pnpm-lock.yaml
            pnpm install
            echo "Lockfile regenerated successfully"
          else
            echo "Frozen lockfile installation successful"
          fi

      - name: Run ESLint security rules
        if: steps.check-service.outputs.exists == 'true'
        working-directory: ${{ matrix.service.path }}
        run: |
          echo "ğŸ” Running ESLint security checks for ${{ matrix.service.name }}"

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ESLintãƒ«ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ] || [ -f "eslint.config.mjs" ]; then
            pnpm run lint --format=json --output-file=eslint-security-report.json || true

            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®è­¦å‘Šãƒ»ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
            SECURITY_ISSUES=$(jq '[.[] | select(.messages[].ruleId | test("security|no-eval|no-implied-eval"))] | length' eslint-security-report.json 2>/dev/null || echo "0")

            if [ "$SECURITY_ISSUES" -gt 0 ]; then
              echo "âš ï¸ Found $SECURITY_ISSUES security-related ESLint issues in ${{ matrix.service.name }}"
              echo "::warning::${{ matrix.service.name }} has $SECURITY_ISSUES security-related ESLint issues"
            else
              echo "âœ… No security-related ESLint issues found in ${{ matrix.service.name }}"
            fi
          else
            echo "â„¹ï¸ No ESLint configuration found in ${{ matrix.service.name }}"
          fi

      - name: Upload ESLint security report
        if: steps.check-service.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: eslint-security-${{ matrix.service.name }}
          path: ${{ matrix.service.path }}/eslint-security-report.json
          retention-days: 30

  # Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³
  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'

    strategy:
      matrix:
        service: ['user-service', 'movie-service', 'actor-service', 'scene-service', 'review-service']

    steps:
      - uses: actions/checkout@v4

      - name: Check if Dockerfile exists
        id: check-dockerfile
        run: |
          if [ -f "backend/${{ matrix.service }}/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Dockerfile found for ${{ matrix.service }}"
          fi

      - name: Build Docker image for scanning
        if: steps.check-dockerfile.outputs.exists == 'true'
        run: |
          docker build -t cinecom/${{ matrix.service }}:scan backend/${{ matrix.service }}

      - name: Run Trivy vulnerability scanner
        if: steps.check-dockerfile.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'cinecom/${{ matrix.service }}:scan'
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        if: steps.check-dockerfile.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'
          category: 'trivy-${{ matrix.service }}'

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœé›†ç´„
  security-summary:
    runs-on: ubuntu-latest
    needs: [codeql-analysis, dependency-scan, secret-scan, eslint-security, container-scan]
    if: always()

    permissions:
      actions: read
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate security summary
        run: |
          echo "# ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼" > security-summary.md
          echo "" >> security-summary.md
          echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-summary.md
          echo "**ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}" >> security-summary.md
          echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> security-summary.md
          echo "" >> security-summary.md

          # å„ã‚¹ã‚­ãƒ£ãƒ³ã®çµæœã‚’ãƒã‚§ãƒƒã‚¯
          echo "## ã‚¹ã‚­ãƒ£ãƒ³çµæœ" >> security-summary.md
          echo "" >> security-summary.md

          # CodeQL
          if [ "${{ needs.codeql-analysis.result }}" = "success" ]; then
            echo "âœ… **CodeQLåˆ†æ**: å®Œäº†" >> security-summary.md
          elif [ "${{ needs.codeql-analysis.result }}" = "failure" ]; then
            echo "âŒ **CodeQLåˆ†æ**: è„†å¼±æ€§æ¤œå‡º" >> security-summary.md
          else
            echo "â­ï¸ **CodeQLåˆ†æ**: ã‚¹ã‚­ãƒƒãƒ—" >> security-summary.md
          fi

          # ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³
          if [ "${{ needs.dependency-scan.result }}" = "success" ]; then
            echo "âœ… **ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³**: å®Œäº†" >> security-summary.md
          elif [ "${{ needs.dependency-scan.result }}" = "failure" ]; then
            echo "âŒ **ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³**: è„†å¼±æ€§æ¤œå‡º" >> security-summary.md
          else
            echo "â­ï¸ **ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³**: ã‚¹ã‚­ãƒƒãƒ—" >> security-summary.md
          fi

          # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º
          if [ "${{ needs.secret-scan.result }}" = "success" ]; then
            echo "âœ… **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º**: å®Œäº†" >> security-summary.md
          elif [ "${{ needs.secret-scan.result }}" = "failure" ]; then
            echo "âŒ **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º**: æ©Ÿå¯†æƒ…å ±æ¤œå‡º" >> security-summary.md
          else
            echo "â­ï¸ **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º**: ã‚¹ã‚­ãƒƒãƒ—" >> security-summary.md
          fi

          # ESLint ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          if [ "${{ needs.eslint-security.result }}" = "success" ]; then
            echo "âœ… **ESLint ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: å®Œäº†" >> security-summary.md
          elif [ "${{ needs.eslint-security.result }}" = "failure" ]; then
            echo "âŒ **ESLint ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«é•åæ¤œå‡º" >> security-summary.md
          else
            echo "â­ï¸ **ESLint ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ã‚¹ã‚­ãƒƒãƒ—" >> security-summary.md
          fi

          # ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚­ãƒ£ãƒ³
          if [ "${{ needs.container-scan.result }}" = "success" ]; then
            echo "âœ… **ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚­ãƒ£ãƒ³**: å®Œäº†" >> security-summary.md
          elif [ "${{ needs.container-scan.result }}" = "failure" ]; then
            echo "âŒ **ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚­ãƒ£ãƒ³**: è„†å¼±æ€§æ¤œå‡º" >> security-summary.md
          else
            echo "â­ï¸ **ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚­ãƒ£ãƒ³**: ã‚¹ã‚­ãƒƒãƒ—" >> security-summary.md
          fi

          echo "" >> security-summary.md
          echo "## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> security-summary.md
          echo "" >> security-summary.md

          # å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ãŒã‚ã‚‹å ´åˆã®æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          if [ "${{ needs.codeql-analysis.result }}" = "failure" ] ||
             [ "${{ needs.dependency-scan.result }}" = "failure" ] ||
             [ "${{ needs.secret-scan.result }}" = "failure" ] ||
             [ "${{ needs.eslint-security.result }}" = "failure" ] ||
             [ "${{ needs.container-scan.result }}" = "failure" ]; then
            echo "ğŸš¨ **ç·Šæ€¥**: æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§ã¾ãŸã¯å•é¡Œã‚’ç¢ºèªã—ã€ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚" >> security-summary.md
            echo "" >> security-summary.md
            echo "1. GitHub Security ã‚¿ãƒ–ã§è©³ç´°ã‚’ç¢ºèª" >> security-summary.md
            echo "2. ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> security-summary.md
            echo "3. è„†å¼±æ€§ã‚’ä¿®æ­£å¾Œã€å†å®Ÿè¡Œ" >> security-summary.md
          else
            echo "ğŸ‰ ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼" >> security-summary.md
          fi

          # ã‚µãƒãƒªãƒ¼ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          cat security-summary.md

      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 90

      - name: Comment PR with security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—æ™‚ã®é€šçŸ¥
  security-notification:
    name: Security Alert Notification
    runs-on: ubuntu-latest
    needs: [codeql-analysis, dependency-scan, secret-scan, eslint-security, container-scan]
    if: failure()

    steps:
      - name: Send Discord notification
        if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—",
                   "description": "CineComãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚",
                   "color": 15158332,
                   "fields": [
                     {
                       "name": "ãƒªãƒã‚¸ãƒˆãƒª",
                       "value": "${{ github.repository }}",
                       "inline": true
                     },
                     {
                       "name": "ãƒ–ãƒ©ãƒ³ãƒ",
                       "value": "${{ github.ref_name }}",
                       "inline": true
                     },
                     {
                       "name": "å®Ÿè¡Œè€…",
                       "value": "${{ github.actor }}",
                       "inline": true
                     },
                     {
                       "name": "è©³ç´°",
                       "value": "[GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                     }
                   ],
                   "timestamp": "${{ github.event.head_commit.timestamp }}"
                 }]
               }' \
               "${{ secrets.DISCORD_SECURITY_WEBHOOK_URL }}" || echo "Discord webhook not configured"
